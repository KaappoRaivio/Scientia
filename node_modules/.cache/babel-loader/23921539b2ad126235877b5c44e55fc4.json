{"ast":null,"code":"var _jsxFileName = \"/home/kaappo/git/kments/src/components/wind.js\";\nimport React from 'react';\nimport { mod } from \"mathjs\";\nimport NumberDisplay from \"./numberdisplay.js\";\nimport DrawHelper from './helpers';\nimport \"./wind.css\";\nimport Interpolator from \"./misc/interpolate.js\";\nimport Tridata from './tridata.js';\n\nclass Wind extends React.Component {\n  constructor(props) {\n    super(props);\n    this.data = {};\n    this.state = {\n      closeHaulAngle: 41,\n      \"angleTrueWater\": 0,\n      \"angleApparent\": 0,\n      \"speedTrue\": 4,\n      \"speedApparent\": 5,\n      interpolated: {\n        angleTrueWater: 0,\n        angleApparent: 0,\n        speedTrue: 0\n      }\n    };\n  }\n\n  subscribe() {\n    this.counter = 1;\n\n    this.onMessage = message => {\n      let path = message.values[0].path.split(\".\")[2];\n\n      if (path === \"angleTrueWater\") {\n        this.setState(state => {\n          let left = 45;\n          let right = 135;\n          return {\n            // angleTrueWater: state.angleTrueWater === left / 180 * Math.PI ? right / 180 * Math.PI : left / 180 * Math.PI,\n            angleApparent: state.angleApparent === left / 180 * Math.PI ? right / 180 * Math.PI : left / 180 * Math.PI\n          };\n        });\n        this.data.interpolators.true.addDataPoint(new Date().getTime(), this.state[\"angleTrueWater\"]);\n        this.data.interpolators.app.addDataPoint(new Date().getTime(), this.state.angleApparent);\n        return;\n      } else {\n        return;\n      } // if (path in this.state) {\n      //     this.setState({\n      //         [path]: message.values[0].value\n      //     })\n      // }\n\n\n      if (path === \"angleTrueWater\") {\n        this.data.interpolators.true.addDataPoint(new Date().getTime(), this.state[\"angleTrueWater\"]);\n      } else if (path === \"angleApparent\") {\n        this.data.interpolators.app.addDataPoint(new Date().getTime(), this.state.angleApparent);\n      } else if (path === \"speedTrue\") {\n        this.data.interpolators.speedTrue.addDataPoint(new Date().getTime(), this.state.speedTrue);\n      }\n    };\n\n    this.props.subscribe([\"environment\\.wind\\..+\"], this.onMessage.bind(this));\n    setInterval(() => {\n      let trueValue = this.data.interpolators.true.interpolate(new Date().getTime());\n      let trueSpeed = this.data.interpolators.speedTrue.interpolate(new Date().getTime());\n      let apparentValue = this.data.interpolators.app.interpolate(new Date().getTime());\n      this.setState({\n        interpolated: {\n          angleTrueWater: trueValue,\n          angleApparent: apparentValue,\n          speedTrue: trueSpeed\n        }\n      });\n    }, 16);\n  }\n\n  componentDidMount() {\n    this.subscribe();\n    const canvas = this.refs.canvas_background;\n    const ctx = canvas.getContext(\"2d\");\n    const canvas_update = this.refs.canvas_update;\n    const ctx_update = canvas_update.getContext(\"2d\");\n    this.data = {\n      canvas_background: canvas,\n      ctx_background: ctx,\n      canvas_update: canvas_update,\n      ctx_update: ctx_update,\n      drawHelper: new DrawHelper(canvas, ctx),\n      interpolators: {\n        true: new Interpolator(false),\n        app: new Interpolator(true),\n        speedTrue: new Interpolator()\n      },\n      compassLineMaxLength: canvas.width / 2.1 / 20,\n      origin: [canvas.width / 2, canvas.height / 2],\n      radius: canvas.width / 2.1\n    };\n    this.drawBackground();\n    this.componentDidUpdate();\n  }\n\n  drawBackground() {\n    const ctx = this.data.ctx_background;\n    const canvas = this.data.canvas_update;\n    ctx.beginPath();\n    ctx.arc(canvas.width / 2, canvas.height / 2, this.data.radius, 0, 2 * Math.PI);\n    ctx.font = \"20px Courier\";\n    const divisions = [[24, 0.5], [72, 1]];\n\n    for (const division of divisions) {\n      let angleProvider = index => {\n        return 2 * Math.PI / division[0] * index;\n      };\n\n      let numberTextProvider = index => {\n        if (division[0] === 24) {\n          let baseAngle = angleProvider(index);\n          return baseAngle / Math.PI * 180 <= 180 ? mod(baseAngle / Math.PI * 180, 360).toFixed(0) : mod(360 - baseAngle / Math.PI * 180, 360).toFixed(0);\n        } else {\n          return \"\";\n        }\n      };\n\n      this.data.drawHelper.drawDivision(this.data.origin, this.data.radius, division[0], this.data.compassLineMaxLength / division[1], angleProvider, numberTextProvider, false);\n    }\n\n    ctx.closePath();\n    ctx.stroke();\n  }\n\n  componentDidUpdate() {\n    const ctx = this.data.ctx_update;\n    const canvas = this.data.canvas_update;\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n    this.drawCloseHaulMarks();\n    this.drawPointer();\n  }\n\n  drawCloseHaulMarks() {\n    const ctx = this.data.ctx_update;\n    ctx.beginPath();\n    ctx.fillStyle = \"rgba(0, 200, 0, 0.75)\";\n    ctx.arc(this.data.origin[0], this.data.origin[1], this.data.radius, -Math.PI / 2, (90 - this.state.closeHaulAngle) / 180 * -Math.PI, false);\n    ctx.arc(this.data.origin[0], this.data.origin[1], this.data.radius - this.data.compassLineMaxLength, (90 - this.state.closeHaulAngle) / 180 * -Math.PI, -Math.PI / 2, true);\n    ctx.closePath();\n    ctx.fill();\n    ctx.beginPath();\n    ctx.fillStyle = \"rgba(255, 150, 125, 0.75)\";\n    ctx.arc(this.data.origin[0], this.data.origin[1], this.data.radius, -Math.PI - (90 - this.state.closeHaulAngle) / 180 * -Math.PI, -Math.PI / 2, false);\n    ctx.arc(this.data.origin[0], this.data.origin[1], this.data.radius - this.data.compassLineMaxLength, -Math.PI / 2, -Math.PI - (90 - this.state.closeHaulAngle) / 180 * -Math.PI, true);\n    ctx.closePath();\n    ctx.fill();\n  }\n\n  drawPointer() {\n    const ctx = this.data.ctx_update;\n    ctx.lineWidth = 10;\n    this.data.drawHelper.ctx = this.data.ctx_update;\n    ctx.strokeStyle = \"rgb(220, 50, 0)\";\n    ctx.beginPath();\n    this.data.drawHelper.drawCompassLine(this.data.origin, this.state.interpolated.angleTrueWater + Math.PI, -this.data.radius + this.data.compassLineMaxLength * 2, this.data.compassLineMaxLength * 2);\n    ctx.closePath();\n    ctx.stroke();\n    ctx.strokeStyle = \"rgb(230, 230, 0)\";\n    ctx.beginPath();\n    this.data.drawHelper.drawCompassLine(this.data.origin, this.state.interpolated.angleApparent + Math.PI, -this.data.radius + this.data.compassLineMaxLength * 2, this.data.compassLineMaxLength * 2);\n    ctx.closePath();\n    ctx.stroke();\n    this.data.drawHelper.ctx = this.data.ctx_background;\n  }\n\n  render() {\n    return /*#__PURE__*/React.createElement(\"div\", {\n      className: \"container\",\n      style: {\n        width: this.props.width + \"px\",\n        height: this.props.height + \"px\"\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 194,\n        columnNumber: 16\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"layerCentered\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 195,\n        columnNumber: 13\n      }\n    }, /*#__PURE__*/React.createElement(NumberDisplay, {\n      value: this.state.interpolated.speedTrue,\n      suffix: \"\",\n      unit: \"kts\",\n      width: this.props.width / 2,\n      height: this.props.height / 3,\n      upperBound: 99,\n      decimalPlaces: 1,\n      fontSize: this.props.width / 6,\n      legend: \"Tuulen nopeus\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 196,\n        columnNumber: 17\n      }\n    })), /*#__PURE__*/React.createElement(\"canvas\", {\n      ref: \"canvas_update\",\n      className: \"layer\",\n      width: this.props.width,\n      height: this.props.height,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 208,\n        columnNumber: 13\n      }\n    }), /*#__PURE__*/React.createElement(\"canvas\", {\n      ref: \"canvas_background\",\n      className: \"layer\",\n      width: this.props.width,\n      height: this.props.height,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 209,\n        columnNumber: 13\n      }\n    }));\n  }\n\n}\n\nexport default Wind;","map":{"version":3,"sources":["/home/kaappo/git/kments/src/components/wind.js"],"names":["React","mod","NumberDisplay","DrawHelper","Interpolator","Tridata","Wind","Component","constructor","props","data","state","closeHaulAngle","interpolated","angleTrueWater","angleApparent","speedTrue","subscribe","counter","onMessage","message","path","values","split","setState","left","right","Math","PI","interpolators","true","addDataPoint","Date","getTime","app","bind","setInterval","trueValue","interpolate","trueSpeed","apparentValue","componentDidMount","canvas","refs","canvas_background","ctx","getContext","canvas_update","ctx_update","ctx_background","drawHelper","compassLineMaxLength","width","origin","height","radius","drawBackground","componentDidUpdate","beginPath","arc","font","divisions","division","angleProvider","index","numberTextProvider","baseAngle","toFixed","drawDivision","closePath","stroke","clearRect","drawCloseHaulMarks","drawPointer","fillStyle","fill","lineWidth","strokeStyle","drawCompassLine","render"],"mappings":"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","sourcesContent":["import React from 'react';\n\nimport { mod } from \"mathjs\";\nimport NumberDisplay from \"./numberdisplay.js\"\nimport DrawHelper from './helpers';\nimport \"./wind.css\"\n\nimport Interpolator from \"./misc/interpolate.js\"\nimport Tridata from './tridata.js';\n\nclass Wind extends React.Component {\n    constructor (props) {\n        super(props);\n        this.data = {}\n\n        this.state = {\n            closeHaulAngle: 41,\n\n            \"angleTrueWater\": 0,\n            \"angleApparent\": 0,\n            \"speedTrue\": 4,\n            \"speedApparent\": 5,\n\n            interpolated: {\n                angleTrueWater: 0,\n                angleApparent: 0,\n                speedTrue: 0,\n            },\n        }\n\n    }\n\n    subscribe() {\n        this.counter = 1;\n        this.onMessage = (message) => {\n            let path = message.values[0].path.split(\".\")[2];\n\n            if (path === \"angleTrueWater\") {\n                this.setState((state) => {\n                    let left = 45;\n                    let right = 135;\n                    return {\n                        // angleTrueWater: state.angleTrueWater === left / 180 * Math.PI ? right / 180 * Math.PI : left / 180 * Math.PI,\n                        angleApparent: state.angleApparent === left / 180 * Math.PI ? right / 180 * Math.PI : left / 180 * Math.PI\n                    }\n                })\n                this.data.interpolators.true.addDataPoint(new Date().getTime(), this.state[\"angleTrueWater\"]);\n                this.data.interpolators.app.addDataPoint(new Date().getTime(), this.state.angleApparent);\n                return;\n            } else {\n                return;\n            }\n\n            // if (path in this.state) {\n            //     this.setState({\n            //         [path]: message.values[0].value\n            //     })\n            // }\n            \n            if (path === \"angleTrueWater\") {\n                this.data.interpolators.true.addDataPoint(new Date().getTime(), this.state[\"angleTrueWater\"]);\n            } else if (path === \"angleApparent\") {\n                this.data.interpolators.app.addDataPoint(new Date().getTime(), this.state.angleApparent);\n            } else if (path === \"speedTrue\") {\n                this.data.interpolators.speedTrue.addDataPoint(new Date().getTime(), this.state.speedTrue);\n            }\n        }\n        this.props.subscribe([\"environment\\.wind\\..+\"], this.onMessage.bind(this))\n\n        setInterval(() => {\n            let trueValue = this.data.interpolators.true.interpolate(new Date().getTime());\n            let trueSpeed = this.data.interpolators.speedTrue.interpolate(new Date().getTime());\n            let apparentValue = this.data.interpolators.app.interpolate(new Date().getTime());\n            this.setState({\n                interpolated: {\n                    angleTrueWater: trueValue,\n                    angleApparent: apparentValue,\n                    speedTrue: trueSpeed,\n                }\n            })\n        }, 16)\n    }\n\n    componentDidMount() {\n        this.subscribe()\n\n        const canvas = this.refs.canvas_background;\n        const ctx = canvas.getContext(\"2d\");\n\n        const canvas_update = this.refs.canvas_update;\n        const ctx_update = canvas_update.getContext(\"2d\");\n\n        this.data = {\n            canvas_background: canvas,\n            ctx_background: ctx,\n\n            canvas_update: canvas_update,\n            ctx_update: ctx_update,\n\n            drawHelper: new DrawHelper(canvas, ctx),\n            interpolators: {\n                true: new Interpolator(false),  \n                app: new Interpolator(true),\n                speedTrue: new Interpolator(),\n            },\n                \n            compassLineMaxLength: canvas.width / 2.1 / 20,\n            origin: [canvas.width / 2, canvas.height / 2],\n            radius: canvas.width / 2.1,\n        };\n        \n        this.drawBackground();\n        this.componentDidUpdate();\n    }\n\n    drawBackground() {\n        const ctx = this.data.ctx_background;\n        const canvas = this.data.canvas_update;\n        \n        ctx.beginPath();\n        ctx.arc(canvas.width / 2, canvas.height / 2, this.data.radius, 0, 2 * Math.PI);\n        ctx.font = \"20px Courier\"\n\n        const divisions = [[24, 0.5], [72, 1]];\n        for (const division of divisions) {\n            let angleProvider = (index) => {\n                return 2 * Math.PI / division[0] * index;\n            }\n\n            let numberTextProvider = (index) => {\n                if (division[0] === 24) {\n                    let baseAngle = angleProvider(index);\n                    return baseAngle / Math.PI * 180 <= 180 ? mod(baseAngle / Math.PI * 180, 360).toFixed(0) : mod(360 - baseAngle / Math.PI * 180, 360).toFixed(0);\n                } else {\n                    return \"\";\n                }\n            }\n\n            this.data.drawHelper.drawDivision(this.data.origin, this.data.radius, division[0], this.data.compassLineMaxLength / division[1], angleProvider, numberTextProvider, false);\n        }\n\n        ctx.closePath();\n        ctx.stroke();\n    }\n\n    componentDidUpdate() {\n        const ctx = this.data.ctx_update;\n        const canvas = this.data.canvas_update;\n        ctx.clearRect(0, 0, canvas.width, canvas.height);\n        this.drawCloseHaulMarks();\n        this.drawPointer();\n    }\n\n    drawCloseHaulMarks () {\n        const ctx = this.data.ctx_update;\n        ctx.beginPath();\n        ctx.fillStyle = \"rgba(0, 200, 0, 0.75)\"\n        ctx.arc(this.data.origin[0], this.data.origin[1], this.data.radius, -Math.PI / 2, (90 - this.state.closeHaulAngle) / 180 * -Math.PI, false);\n        ctx.arc(this.data.origin[0], this.data.origin[1], this.data.radius - this.data.compassLineMaxLength, (90 - this.state.closeHaulAngle) / 180 * -Math.PI, -Math.PI / 2, true);\n        ctx.closePath();\n        ctx.fill();\n        \n        ctx.beginPath();\n        ctx.fillStyle = \"rgba(255, 150, 125, 0.75)\"\n        ctx.arc(this.data.origin[0], this.data.origin[1], this.data.radius, -Math.PI - (90 - this.state.closeHaulAngle) / 180 * -Math.PI, -Math.PI / 2, false);\n        ctx.arc(this.data.origin[0], this.data.origin[1], this.data.radius - this.data.compassLineMaxLength, -Math.PI / 2, -Math.PI - (90 - this.state.closeHaulAngle) / 180 * -Math.PI, true);\n        ctx.closePath();\n        ctx.fill();\n\n    }\n\n    drawPointer () {\n        const ctx = this.data.ctx_update;\n        ctx.lineWidth = 10;\n        this.data.drawHelper.ctx = this.data.ctx_update;\n        \n        ctx.strokeStyle = \"rgb(220, 50, 0)\";\n        ctx.beginPath();\n        this.data.drawHelper.drawCompassLine(this.data.origin, this.state.interpolated.angleTrueWater + Math.PI, -this.data.radius + this.data.compassLineMaxLength * 2, this.data.compassLineMaxLength * 2)\n        ctx.closePath();\n        ctx.stroke()\n        \n        \n        ctx.strokeStyle = \"rgb(230, 230, 0)\";\n        ctx.beginPath()\n        this.data.drawHelper.drawCompassLine(this.data.origin, this.state.interpolated.angleApparent + Math.PI, -this.data.radius + this.data.compassLineMaxLength * 2, this.data.compassLineMaxLength* 2)\n        ctx.closePath();\n        ctx.stroke();\n        \n        this.data.drawHelper.ctx = this.data.ctx_background;\n    }\n\n    render() {\n        return <div className=\"container\" style={{ width: this.props.width + \"px\", height: this.props.height + \"px\" }}>\n            <div className=\"layerCentered\">\n                <NumberDisplay\n                    value={this.state.interpolated.speedTrue}\n                    suffix=\"\"\n                    unit=\"kts\"\n                    width={this.props.width / 2}\n                    height={this.props.height / 3}\n                    upperBound={99}\n                    decimalPlaces={1}\n                    fontSize={this.props.width / 6}\n                    legend=\"Tuulen nopeus\"\n                />\n            </div>\n            <canvas ref=\"canvas_update\" className=\"layer\" width={this.props.width} height={this.props.height} />\n            <canvas ref=\"canvas_background\" className=\"layer\" width={this.props.width} height={this.props.height} />\n        </div>\n    }\n}\n\nexport default Wind"]},"metadata":{},"sourceType":"module"}