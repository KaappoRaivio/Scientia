{"ast":null,"code":"var _jsxFileName = \"/home/kaappo/git/kments/src/components/compass.js\";\nimport React from 'react';\nimport { mod } from \"mathjs\";\nimport \"./compass.css\";\nimport NumberDisplay from \"./numberdisplay.js\";\nimport DrawHelper from \"./helpers.js\";\nimport Interpolator from './misc/interpolate';\n\nclass Compass extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      heading: 0,\n      interpolated: 0\n    };\n  }\n\n  getCircleRadius(canvasWidth, offsetY) {\n    return Math.sqrt((canvasWidth / 2) ** 2 + offsetY ** 2) / 1.05;\n  }\n\n  componentDidMount() {\n    this.subscribe();\n    const canvas = this.refs.canvas;\n    const ctx = canvas.getContext(\"2d\");\n    const arcCenterOffsetY = canvas.width / 5;\n    const radius = this.getCircleRadius(canvas.width, arcCenterOffsetY);\n    const compassLineMaxLength = canvas.width / 2 / 10;\n    const origin = [canvas.width / 2, canvas.height + arcCenterOffsetY];\n    const drawHelper = new DrawHelper(canvas, ctx);\n    this.data = {\n      canvas_background: canvas,\n      ctx_backgroud: ctx,\n      compassLineMaxLength: compassLineMaxLength,\n      origin: origin,\n      radius: radius,\n      arcCenterOffsetY: arcCenterOffsetY,\n      drawHelper: drawHelper,\n      interpolator: new Interpolator(true)\n    };\n    this.componentDidUpdate();\n  }\n\n  subscribe() {\n    this.onMessage = message => {\n      const extracted = message.values[0].value;\n\n      if (message.source.label === \"nmeaFromFile\") {\n        this.setState({\n          heading: extracted / Math.PI * 180\n        });\n        this.data.interpolator.addDataPoint(new Date().getTime(), extracted);\n      }\n    };\n\n    this.props.subscribe([\"navigation.courseOverGroundTrue\"], this.onMessage);\n    setInterval(() => {\n      let heading = this.data.interpolator.interpolate(new Date().getTime());\n      this.setState({\n        interpolated: heading / Math.PI * 180\n      });\n    }, 16);\n  }\n\n  componentDidUpdate() {\n    const ctx = this.data.ctx_backgroud;\n    const canvas = this.data.canvas_background;\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n    ctx.beginPath();\n    ctx.arc(canvas.width / 2, canvas.height + this.data.arcCenterOffsetY, this.data.radius, 0, 2 * Math.PI);\n    ctx.fillRect(this.props.width / 2 - 1, canvas.height - this.data.radius + this.data.arcCenterOffsetY - 10, 2, 10);\n    ctx.font = canvas.width / 20 + \"px Courier\";\n    let divisions = [[24, 1], [72, 2], [144, 3]];\n\n    for (let index = 0; index < divisions.length; index++) {\n      let division = divisions[index];\n\n      let angleProvider = index => {\n        let baseAngle = 2 * Math.PI / division[0] * index;\n        let angleOffset = this.state.interpolated * Math.PI / 180;\n        return baseAngle - angleOffset;\n      };\n\n      let numberTextProvider = index => {\n        if (division[0] === 24) {\n          let baseAngle = angleProvider(index) + this.state.interpolated * Math.PI / 180;\n          return mod(baseAngle / Math.PI * 180, 360).toFixed(0);\n        } else {\n          return \"\";\n        }\n      };\n\n      this.data.drawHelper.drawDivision(this.data.origin, this.data.radius, division[0], this.data.compassLineMaxLength / division[1], angleProvider, numberTextProvider);\n    }\n\n    ctx.closePath();\n    ctx.stroke();\n  }\n\n  render() {\n    return /*#__PURE__*/React.createElement(\"div\", {\n      className: \"container\",\n      style: {\n        width: this.props.width + \"px\",\n        height: this.props.height + \"px\"\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 113,\n        columnNumber: 16\n      }\n    }, /*#__PURE__*/React.createElement(NumberDisplay, {\n      className: \"number\",\n      value: this.state.interpolated,\n      suffix: \"\\xB0\",\n      unit: \"T\",\n      width: this.props.width,\n      height: this.props.height / 3 * 2,\n      upperBound: 360,\n      decimalPlaces: 1,\n      fontSize: this.props.width / 4,\n      legend: \"\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 114,\n        columnNumber: 13\n      }\n    }), /*#__PURE__*/React.createElement(\"canvas\", {\n      ref: \"canvas\",\n      className: \"compassRose\",\n      width: this.props.width,\n      height: this.props.height / 2,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 126,\n        columnNumber: 13\n      }\n    }));\n  }\n\n}\n\nexport default Compass;","map":{"version":3,"sources":["/home/kaappo/git/kments/src/components/compass.js"],"names":["React","mod","NumberDisplay","DrawHelper","Interpolator","Compass","Component","constructor","props","state","heading","interpolated","getCircleRadius","canvasWidth","offsetY","Math","sqrt","componentDidMount","subscribe","canvas","refs","ctx","getContext","arcCenterOffsetY","width","radius","compassLineMaxLength","origin","height","drawHelper","data","canvas_background","ctx_backgroud","interpolator","componentDidUpdate","onMessage","message","extracted","values","value","source","label","setState","PI","addDataPoint","Date","getTime","setInterval","interpolate","clearRect","beginPath","arc","fillRect","font","divisions","index","length","division","angleProvider","baseAngle","angleOffset","numberTextProvider","toFixed","drawDivision","closePath","stroke","render"],"mappings":"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","sourcesContent":["import React from 'react';\n\nimport { mod } from \"mathjs\";\nimport \"./compass.css\"\nimport NumberDisplay from \"./numberdisplay.js\"\n\nimport DrawHelper from \"./helpers.js\"\nimport Interpolator from './misc/interpolate';\n\nclass Compass extends React.Component {\n    constructor(props) {\n        super(props);\n\n        this.state = {\n            heading: 0,\n            interpolated: 0\n        }\n    }\n\n    getCircleRadius (canvasWidth, offsetY) {\n        return Math.sqrt((canvasWidth / 2) ** 2 + offsetY ** 2) / 1.05\n    }\n\n    componentDidMount() {\n        this.subscribe();\n        \n        const canvas = this.refs.canvas;\n        const ctx = canvas.getContext(\"2d\");\n        \n        const arcCenterOffsetY = canvas.width / 5;\n        const radius = this.getCircleRadius(canvas.width, arcCenterOffsetY);\n        \n        const compassLineMaxLength = canvas.width / 2 / 10\n        const origin = [canvas.width / 2, canvas.height + arcCenterOffsetY];\n\n        const drawHelper = new DrawHelper(canvas, ctx);\n\n        this.data = {\n            canvas_background: canvas,\n            ctx_backgroud: ctx,\n\n            compassLineMaxLength: compassLineMaxLength,\n            origin: origin,\n            radius: radius,\n            arcCenterOffsetY: arcCenterOffsetY,\n\n            drawHelper: drawHelper,\n            interpolator: new Interpolator(true),\n        }\n\n        this.componentDidUpdate();        \n    }\n\n    subscribe () {\n        this.onMessage = (message) => {\n            const extracted = message.values[0].value;\n            if (message.source.label === \"nmeaFromFile\") {\n                this.setState({ heading: extracted / Math.PI * 180 });\n\n                this.data.interpolator.addDataPoint(new Date().getTime(), extracted);\n            }\n        }\n        this.props.subscribe([\"navigation.courseOverGroundTrue\"], this.onMessage)\n\n        setInterval(() => {\n            let heading = this.data.interpolator.interpolate(new Date().getTime());\n            this.setState({\n                interpolated: heading / Math.PI * 180\n            })\n        }, 16)\n\n    }\n\n    componentDidUpdate () {\n        const ctx = this.data.ctx_backgroud;\n        const canvas = this.data.canvas_background;\n\n        ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n        ctx.beginPath();\n        ctx.arc(canvas.width / 2, canvas.height + this.data.arcCenterOffsetY, this.data.radius, 0, 2 * Math.PI);\n        ctx.fillRect(this.props.width / 2 - 1, canvas.height - this.data.radius + this.data.arcCenterOffsetY - 10, 2, 10)\n        ctx.font = canvas.width / 20 + \"px Courier\";\n\n        \n        let divisions = [[24, 1], [72, 2], [144, 3]];\n        for (let index = 0; index < divisions.length; index++) {\n            let division = divisions[index]\n            \n            let angleProvider = (index) => {\n                let baseAngle = 2 * Math.PI / division[0] * index;\n                let angleOffset = this.state.interpolated * Math.PI / 180;\n                return baseAngle - angleOffset;\n            }\n\n            let numberTextProvider = (index) => {\n                if (division[0] === 24) {\n                    let baseAngle = angleProvider(index) + this.state.interpolated * Math.PI / 180\n                    return mod(baseAngle / Math.PI * 180, 360).toFixed(0);\n                } else {\n                    return \"\";\n                }\n            }\n\n            this.data.drawHelper.drawDivision(this.data.origin, this.data.radius, division[0], this.data.compassLineMaxLength / division[1], angleProvider, numberTextProvider)\n        }\n\n        ctx.closePath();\n        ctx.stroke();\n    }\n\n    render () {\n        return <div className=\"container\" style={{width: this.props.width + \"px\", height: this.props.height + \"px\"}}>\n            <NumberDisplay \n                className=\"number\" \n                value={this.state.interpolated} \n                suffix=\"°\" \n                unit=\"T\" \n                width={this.props.width} \n                height={this.props.height / 3 * 2} \n                upperBound={360} \n                decimalPlaces={1} \n                fontSize={this.props.width / 4}\n                legend=\"\" \n            />\n            <canvas ref=\"canvas\" className=\"compassRose\" width={this.props.width} height={this.props.height / 2} />\n        </div>\n    }\n}\n\nexport default Compass"]},"metadata":{},"sourceType":"module"}